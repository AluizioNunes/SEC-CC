services:
  nginx:
    image: nginx:alpine
    container_name: CC-NGINX
    ports:
      - "80:80"
    networks:
      - sec_net

  frontend:
    build:
      context: .
      dockerfile: ./docker/frontend/Dockerfile
    container_name: CC-FRONTEND
    volumes:
      - frontend_dist:/app/dist
    ports:
      - "5173:80"
    networks:
      - sec_net

  fastapi:
    build:
      context: ./Backend/FastAPI
      dockerfile: Dockerfile
    container_name: CC-FASTAPI
    environment:
      POSTGRES_URL: ${POSTGRES_URL}
      MONGODB_URL: ${MONGODB_URL}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      LOG_LEVEL: ${FASTAPI_LOG_LEVEL:-info}
    ports:
      - "8000:8000"
    networks:
      - sec_net

  nestjs:
    build:
      context: ./Backend/NestJS
      dockerfile: Dockerfile
    container_name: CC-NESTJS
    environment:
      PORT: ${NESTJS_PORT:-3000}
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
    ports:
      - "3000:3000"
    networks:
      - sec_net
    depends_on:
      - redis

  postgres:
    image: postgres:17.6-alpine
    container_name: CC-POSTGRESQL
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - sec_net

  redis:
    image: redis:latest
    container_name: CC-REDIS
    ports:
      - "6379:6379"
    networks:
      - sec_net

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: CC-RABBITMQ
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-admin123}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./docker/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./docker/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    networks:
      - sec_net

  grafana:
    image: grafana/grafana:latest
    container_name: CC-GRAFANA
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - sec_net

  mongodb:
    image: mongo:latest
    container_name: CC-MONGODB
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"
    networks:
      - sec_net

  prometheus:
    image: prom/prometheus:latest
    container_name: CC-PROMETHEUS
    environment:
      - PROMETHEUS_CONFIG_FILE=/etc/prometheus/prometheus.yml
    configs:
      - source: prometheus_config
        target: /etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - sec_net

  loki:
    image: grafana/loki:2.9.8
    container_name: CC-LOKI
    environment:
      - LOKI_CONFIG_FILE=/etc/loki/config.yml
    configs:
      - source: loki_config
        target: /etc/loki/config.yml
    ports:
      - "3100:3100"
    networks:
      - sec_net

  promtail:
    image: grafana/promtail:2.9.8
    container_name: CC-PROMTAIL
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro  # Logs do sistema host
    environment:
      - PROMTAIL_CONFIG_FILE=/etc/promtail/config.yml
    configs:
      - source: promtail_config
        target: /etc/promtail/config.yml
    ports:
      - "9080:9080"
    networks:
      - sec_net

networks:
  sec_net:
    driver: bridge

volumes:
  frontend_dist:
  postgres_data:
  mongo_data:
  grafana_data:
  rabbitmq_data:

configs:
  promtail_config:
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: http://loki:3100/loki/api/v1/push
          batchwait: 1s
          batchsize: 102400

      scrape_configs:
        # Logs de containers Docker (todos os serviços)
        - job_name: container-logs
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: ['__meta_docker_container_name']
              regex: '/(.*)'
              target_label: 'container'
            - source_labels: ['__meta_docker_container_log_stream']
              target_label: 'logstream'
            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
              target_label: 'service'
            - replacement: '$${1}'
              source_labels: ['__meta_docker_container_name']
              regex: '/(.*)'
              target_label: 'container_name'
          pipeline_stages:
            - json:
                expressions:
                  output: log
                  stream: stream
                  timestamp: time
            - timestamp:
                source: timestamp
                format: RFC3339Nano
            - output:
                source: output

        # Logs do sistema host
        - job_name: system-logs
          static_configs:
            - targets:
                - localhost
              labels:
                job: system
                __path__: /var/log/*log
          pipeline_stages:
            - multiline:
                firstline: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
                max_wait_time: 10s
                max_lines: 1000

        # Logs de aplicações específicas (se existirem arquivos)
        - job_name: application-logs
          static_configs:
            - targets:
                - localhost
              labels:
                job: application
                __path__: /var/log/app/*.log
          pipeline_stages:
            - multiline:
                firstline: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
                max_wait_time: 10s

  prometheus_config:
    content: |
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      
      rule_files:
        # - "first_rules.yml"
        # - "second_rules.yml"
      
      scrape_configs:
        - job_name: 'prometheus'
          static_configs:
            - targets: ['localhost:9090']
      
        - job_name: 'loki'
          static_configs:
            - targets: ['loki:3100']
          metrics_path: '/metrics'
      
        - job_name: 'grafana'
          static_configs:
            - targets: ['grafana:3000']
      
        - job_name: 'fastapi'
          static_configs:
            - targets: ['fastapi:8000']
          metrics_path: '/metrics'
      
        - job_name: 'nestjs'
          static_configs:
            - targets: ['nestjs:3000']
          metrics_path: '/metrics'

  loki_config:
    content: |
      auth_enabled: false

      server:
        http_listen_port: 3100
        grpc_listen_port: 9096

      common:
        instance_addr: 127.0.0.1
        path_prefix: /tmp/loki
        storage:
          filesystem:
            chunks_directory: /tmp/loki/chunks
            rules_directory: /tmp/loki/rules
        replication_factor: 1
        ring:
          kvstore:
            store: inmemory

      query_range:
        results_cache:
          cache:
            embedded_cache:
              enabled: true
              max_size_mb: 100

      schema_config:
        configs:
          - from: 2020-10-24
            store: boltdb-shipper
            object_store: filesystem
            schema: v11
            index:
              prefix: index_
              period: 24h

      ruler:
        alertmanager_url: http://localhost:9093

      ingester:
        lifecycler:
          address: 127.0.0.1
          ring:
            kvstore:
              store: inmemory
            replication_factor: 1
          final_sleep: 0s
        chunk_idle_period: 5m
        max_chunk_age: 1h
        chunk_target_size: 1048576
        chunk_retain_period: 30s
        max_transfer_retries: 0

      limits_config:
        reject_old_samples: true
        reject_old_samples_max_age: 168h
